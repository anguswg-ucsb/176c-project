---
title: "Geography 176C"
subtitle: "NWM catchments and flow data"
author: "Angus Watters"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ucsb.css
    nature:
      ratio: 16:10
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{css, eval = TRUE, echo = FALSE}
.remark-code{line-height: 2; font-size: 60%}
```
```{r, include = F}
knitr::opts_chunk$set(fig.width = 8, message = FALSE, warning = FALSE, comment = "", cache = FALSE, fig.retina = 3)
library(flipbookr)
library(tidyverse)
library(cowplot)
library(ggplot2)
library(highcharter)
precip <- readRDS("../docs/precip2.rds")
evap <- readRDS("../docs/evap2.rds")

# climate_graph <- function(df, lab) {
#   df$date <- paste0(df$date, "-01")
#   df$date <- as.Date(df$date)
#   rownames(df) <- df$date
#   df <- select(df, 5)
# 
#   dygraph(data = df,
#             ylab = as.character(lab)) %>% 
#       dyHighlight(highlightCircleSize = 4,
#                   highlightSeriesBackgroundAlpha = .4) %>%
#       dyOptions(colors = c("navy"),
#                 fillGraph = TRUE)
# }

climate_graph <- function(df1, df2) {
    highchart() %>%
      hc_yAxis_multiples(list(title = list(text = "Accumulated Precipitation (mm)"),
                            min=0,
                            max = max(df1$prcp),
                            showFirstLabel = TRUE,
                            showLastLabel = TRUE,
                            opposite = FALSE),
                         list(title = list(text = "Actual Evapotranspiration (mm)"),
                            showLastLabel=FALSE,
                            opposite = TRUE)) %>%
      hc_add_series(df1, name = "Precipitation", type = "column",
                    hcaes(x = date, y = prcp), yAxis = 1 ) %>%
      hc_add_series(df2, name = "Evaporation", type = "line",
                    hcaes(x = date, y = aet), yAxis = 0) %>%
      hc_colors(c("darkcyan", "darkred")) %>% 
          hc_xAxis(categories = df1$date) 
}
# p1 <- ggdraw() + draw_image("map-icon.jpg", scale = 0.9)
# p2 <- ggdraw() + draw_image("arrow-icon.png", scale = 0.9)
# p3 <- ggdraw() + draw_image("click-icon.jpg", scale = 0.9)
# p4 <- ggdraw() + draw_image("arrow-icon.png", scale = 0.9)
# p5 <- ggdraw() + draw_image("river2-icon.png", scale = 0.9)
# 
# pics <- plot_grid(p1, p2, p3, p4, p5, nrow = 1)
```

# *Shiny dashboard for streamflow data*

---

# **The National Water Model (NWM)**

- The National Water Model (NWM) is a hydrologic modelling framework that simulates observed and forecast streamflow over the entire continental United States (CONUS). 

- The NWM simulates the water cycle with mathematical representations of the different processes and how they fit together.

--

# **Motivation**

- The NWM obtains data from over 8000 USGS stream gauges in the Nation and uses this data to expand forecasts to over 2.7 million stream locations nationwide.

- This also means that there is a huge amount of historical stream flow data available at all these locations.

---

# **Problem**
There is **NOT** an easy way to view catchments and simultaneously view historical stream flow data for the catchment.
  - The data is all there but currently there isn't a quick and easy way to view both the catchment geometry and time series data on demand.  

--

# **Solution**
- Create a ***R Shiny dashboard*** that allows the user to explore all watershed catchments in the US and get on demand streamflow data

```{r, echo = FALSE,  out.width = "98%"}
knitr::include_graphics('icons.png')
```

---

# **Research questions**

--

**1. What is the relative impact of certain geographic factors on stream flows?**

--
  - Proximity to a dam, population density, land cover

--

<br>

**2. Forecast stream flow rates using precipitation and water withdrawals in a multilayer perceptron Machine learning algorithm**

---

# **Data sources**

--

- Project and data retrieval will use these **R packages**:
  - `tidyr`
  - `dplyer`
  - `sf`
  - `leaflet`
  - `dataRetrieval`
  - `nhdplusTools`
  - `nwmTools`
  - `shiny`
  
---
`r flipbookr::chunk_reveal("nldi", title = "# Find Common ID at clicked point")`
```{r nldi, include=FALSE}
library(dataRetrieval)

# R Client for the Network Linked Data Index
flowline <- findNLDI(location = c(-94.64, 31.09))
flowline 

```

---

`r flipbookr::chunk_reveal("nhd", title = "# Find catchment polygons from COMID")`
```{r nhd, include = FALSE}
library(nhdplusTools)

# Get catchment polygons from National Hydrography Dataset V2 Subsets 
catchment <- get_nhdplus(comid = flowline$comid, 
                   realization = "catchment")
catchment

```

---

`r flipbookr::chunk_reveal("interactive", title = "# View catchments in leaflet")`
```{r interactive, include = FALSE}
library(leaflet)

leaflet() %>% 
  addProviderTiles(providers$Esri.WorldTopoMap) %>% 
  setView(-94.64, 31.09, 13) %>%  
  addPolygons(data = catchment,
              color = "green") %>% 
  addPolylines(data = flowline,
               color = "red",
               opacity = 1) 
```

---


`r flipbookr::chunk_reveal("nwm", title = "# Load NWM historical data using nwmTools package")`

```{r nwm, include = FALSE, eval = FALSE}
# library(nwmTools)
# library(dygraphs)

# Retrieve flow data from the National water model via a COMID
# nwm <- nwmTools::readNWMdata(comid =nldi$comid)
# dygraph
```
---

`r flipbookr::chunk_reveal("climate", title = "# Load climate data using climateR package")`
.pull-left[
```{r climate, include = FALSE, out.width=9}
library(climateR)
library(sf)
library(highcharter)

# Retrieve climate data for the catchment using centroid point
pt <- st_centroid(flowline)

# precip <- getTerraClim(AOI = pt, param = "prcp", startDate = "2011-01-01", endDate = "2014-01-01")
# evap <- getTerraClim(AOI = pt, param = "aet", startDate = "2011-01-01", endDate = "2014-01-01")

climate_graph(precip, evap)
```
---
# Contact info

- **email:** adwattersgrubstein@ucsb.edu

- **phone:** (805) 895-1590

- **GitHub:** https://github.com/anguswg-ucsb


--

- Thanks for your time !

--

---

